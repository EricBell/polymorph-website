version: "3"

services:
  hugo:
    image: alpine:latest
    user: root
    working_dir: /src
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache git hugo
        git config --global --add safe.directory /src
        git submodule update --init --recursive
        hugo --config hugo.toml --baseURL https://polymorph.co/ --destination /tmp/public --cacheDir /tmp/hugo_cache --minify --environment production --cleanDestinationDir
        find /public -mindepth 1 -delete || true
        cp -r /tmp/public/* /public/ || true
        chmod -R 755 /public || true
        echo 'Build complete'
    volumes:
      - ./:/src
      - public-data:/public
    environment:
      - HUGO_ENV=production
    restart: "no"
    networks:
      - dokploy-network

  nginx:
    image: nginx:1.25-alpine
    volumes:
      - public-data:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    depends_on:
      - hugo
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.polymorph-nginx.rule=Host(`polymorph.co`) || Host(`www.polymorph.co`)"
      - "traefik.http.routers.polymorph-nginx.entrypoints=websecure"
      - "traefik.http.routers.polymorph-nginx.tls.certResolver=letsencrypt"
      - "traefik.http.routers.polymorph-nginx.service=polymorph-nginx"
      - "traefik.http.services.polymorph-nginx.loadbalancer.server.port=80"
      - "traefik.http.services.polymorph-nginx.loadbalancer.server.scheme=http"

volumes:
  public-data:

networks:
  dokploy-network:
    external: true