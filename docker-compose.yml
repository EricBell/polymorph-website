version: "3"

services:
  init-submodules:
    image: alpine:3.18
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache git
        git config --global --add safe.directory /src
        cd /src
        git submodule update --init --recursive
        echo 'Submodules initialized'
    volumes:
      - ./:/src:ro
    restart: "no"
    networks:
      - dokploy-network

  hugo:
    image: alpine:latest
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache hugo
        cp -r /src /tmp/build
        cd /tmp/build
        hugo --config hugo.toml --baseURL https://polymorph.co/ --destination /tmp/public --minify --environment production --cleanDestinationDir
        rm -rf /public/*
        cp -r /tmp/public/* /public/
        chmod -R 755 /public
        echo 'Build complete'
    volumes:
      - ./:/src:ro
      - public-data:/public
    environment:
      - HUGO_ENV=production
    restart: "no"
    depends_on:
      - init-submodules
    networks:
      - dokploy-network

  nginx:
    image: nginx:1.25-alpine
    volumes:
      - public-data:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    depends_on:
      - hugo
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.polymorph-nginx.rule=Host(`polymorph.co`) || Host(`www.polymorph.co`)"
      - "traefik.http.routers.polymorph-nginx.entrypoints=websecure"
      - "traefik.http.routers.polymorph-nginx.tls.certResolver=letsencrypt"
      - "traefik.http.routers.polymorph-nginx.service=polymorph-nginx"
      - "traefik.http.services.polymorph-nginx.loadbalancer.server.port=80"
      - "traefik.http.services.polymorph-nginx.loadbalancer.server.scheme=http"

volumes:
  public-data:

networks:
  dokploy-network:
    external: true